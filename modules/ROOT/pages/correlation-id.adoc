= Correlation ID
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: tracing, correlation, id, anypoint, studio

The correlation ID is a unique string identifier for each Mule event. When Mule creates a new event, it also generates a correlation ID before sending the event to the next processor in the flow. This ID enables you to correlate different log entries to a particular execution. By default, Mule generates correlation IDs by generating a Java Universally Unique Identifier (UUID).

The correlation ID can be used to understand the entire history of an event that resulted in an issue, or an unhandled error, because any error includes the correlation ID of the event that triggered it. Also, the correlation ID is  very helpful while performing a memory analysis of heap dumps.

== Correlation ID Generator

Mule runtime follows this procedure before generating a correlation ID:

. If the source contains a correlation ID from the message (for example, an HTTP listener with the `X-CORRELATION-ID` header, or JMS), Mule uses that ID as the correlation ID of the event.
. If the source does not set a correlation ID, Mule generates one.

It is best to avoid making changes to the correlation ID generator, however, there are some scenarios where you might need to format or standardize the correlation ID for the events, for example:

* If your company has its own standard or format for correlation IDs.
* If your external system differs in correlation ID lengths, causing incompatibility with Mule correlation IDs thus breaking traceability.

=== Modify the Correlation ID Generator

To change how Mule generates the correlation ID:

. Add the `<configuration>` component to your application XML.
. Set the `correlationIdGeneratorExpression` attribute and specify the expression that generates the correlation ID:
+
[source,xml,linenums]
----
<configuration correlationIdGeneratorExpression="#[<custom_generator_expression>]"/>
----

In the following example, Mule generates the correlation ID by calling the Java `uuid()` method, and then replaces the dashes (`-`) with dots (`.`):

[source,xml,linenums]
----
<configuration correlationIdGeneratorExpression="#[uuid() replace /-/ with('.')]"/>

<http:listener-config name="HTTP_Listener_config">
	<http:listener-connection host="0.0.0.0" port="8081" />
</http:listener-config>
<flow name="example">
	<http:listener config-ref="HTTP_Listener_config" path="/test"/>
	<set-payload value="some"/>
	<logger level="WARN" message="#[payload]"/>
</flow>
----

After executing the flow, the logger shows the following:

----
WARN  2021-03-30 16:46:11,269 [[MuleRuntime].uber.06: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/1; event: b5a95a63.f190.4c91.880a.5b54512fa6b1] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
----

[IMPORTANT]
When you configure the generator, ensure that the algorithm you use is not able to generate the same correlation ID for two different events.

== Change the Correlation ID During the Flow Execution

There are cases where you want to change the correlation ID of the event for a given scope or a set of operations, for example:

* If you are processing the results of a database query inside a `foreach` scope, and you want to correlate
the event with the register you are processing.
* If you are consuming a JMS message queue and you want to proceed using the JMS correlation ID for traceability purposes.

// We must check this when we get studio support ?
For these scenarios, the `mule-tracing` module enables you to use the `with-correlation-id` scope to modify the correlation ID during the execution of said scope.

image::with-correlation-id-scope.png[width=350]

Consider the following example:

[source,xml,linenums]
----
<http:listener-config name="HTTP_Listener_config">
	<http:listener-connection host="0.0.0.0" port="8081" />
</http:listener-config>
<flow name="example">
	<http:listener config-ref="HTTP_Listener_config" path="/test"/>
	<set-payload value="some"/>
	<logger level="WARN" message="#[payload]"/>
    <tracing:with-correlation-id correlationId="#[correlationId ++ '-EXAMPLE']">
        <logger level="WARN" message="#[payload]"/>
    </tracing:with-correlation-id>
    <logger level="WARN" message="#[payload]"/>
</flow>
----

In this case, the output logs are:
----
WARN  2021-03-30 16:46:11,269 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/1; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
WARN  2021-03-30 16:46:11,271 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/2/processors/0; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee-EXAMPLE] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
WARN  2021-03-30 16:46:11,274 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/3; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
----

=== Correlation ID Logs in DEBUG Level

In case you want to see additional logs related to the correlation ID, you can set the log level to `DEBUG` by adding the following code to your application XML:

----
<AsyncLogger name="org.mule.runtime.module.extension.internal.runtime.operation" level="DEBUG"/>
----

After performing a request to the application from the previous example, the updated logs show as following:

----
WARN  2021-03-30 16:58:29,545 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/1; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
DEBUG 2021-03-30 16:58:29,548 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] org.mule.runtime.module.extension.internal.runtime.operation.ImmutableProcessorChildContextChainExecutor: Changing event correlationId from '4c355b30-9192-11eb-b79f-36548d51aeee' to '4c355b30-9192-11eb-b79f-36548d51aeee-EXAMPLE' in location example/processors/2
WARN  2021-03-30 16:58:29,555 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/2/processors/0; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee-EXAMPLE] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
DEBUG 2021-03-30 16:58:29,566 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] org.mule.runtime.module.extension.internal.runtime.operation.ImmutableProcessorChildContextChainExecutor: Event with correlationId '4c355b30-9192-11eb-b79f-36548d51aeee-EXAMPLE' going back to '4c355b30-9192-11eb-b79f-36548d51aeee' (successful execution) in location example/processors/2
WARN  2021-03-30 16:58:29,568 [[MuleRuntime].uber.05: [test-project-app].example.CPU_LITE @6d3b5ad] [processor: example/processors/3; event: bad0e5b0-9191-11eb-a0b3-36548d51aeee] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
----

== Example: Identifying the Correlation ID in Logs

Consider the following flow:

[source,xml,linenums]
----
<http:listener-config name="HTTP_Listener_config">
	<http:listener-connection host="0.0.0.0" port="8081" />
</http:listener-config>
<flow name="example">
	<http:listener config-ref="HTTP_Listener_config" path="/test"/>
	<set-payload value="some"/>
	<logger level="WARN" message="#[payload]"/>
</flow>
----

After receiving a request, the flow produces the following log:

----
WARN  2021-03-30 14:19:52,862 [[MuleRuntime].uber.04: [test-project-app].example.CPU_LITE @7a3620f2] [processor: example/processors/1; event: 23d22940-917c-11eb-9209-3c22fb13cde7] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
----

In this case, the value `23d22940-917c-11eb-9209-3c22fb13cde7` is the correlation ID. This ID is unique for the corresponding event, so any other log that includes this correlation ID is referring to the same event.

The correlation ID can be used to understand the entire history of an event that resulted in an issue, or an unhandled error, because any error includes the correlation ID of the event that triggered it.

== Example: Logging the Same Correlation ID from Different Operations

Consider the following flow, which is the same as in the previous example but including a `raise-error` component:

[source,xml,linenums]
----
<http:listener-config name="HTTP_Listener_config">
	<http:listener-connection host="0.0.0.0" port="8081" />
</http:listener-config>
<flow name="example">
	<http:listener config-ref="HTTP_Listener_config" path="/test"/>
	<set-payload value="some"/>
	<logger level="WARN" message="#[payload]"/>
	<raise-error type="APP:SOME"/>
</flow>
----

After its execution, the flow generates the following log:

----
WARN  2021-03-30 14:27:36,045 [[MuleRuntime].uber.08: [test-project-app].example.CPU_LITE @19afa17] [processor: example/processors/1; event: 37f0f591-917d-11eb-9209-3c22fb13cde7] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: some
ERROR 2021-03-30 14:27:36,052 [[MuleRuntime].uber.08: [test-project-app].example.CPU_LITE @19afa17] [processor: example/processors/2; event: 37f0f591-917d-11eb-9209-3c22fb13cde7] org.mule.runtime.core.internal.exception.OnErrorPropagateHandler:
********************************************************************************
Message               : An error occurred.
Element               : example/processors/2 @ test-project-app:test-project-app.xml:16
Element DSL           : <raise-error type="APP:SOME"></raise-error>
Error type            : APP:SOME
FlowStack             : at example(example/processors/2 @ test-project-app:test-project-app.xml:16)

  (set debug level logging or '-Dmule.verbose.exceptions=true' for everything)
********************************************************************************
----

When the Logger and the Raise Error components execute, both components log the correlation ID `37f0f591-917d-11eb-9209-3c22fb13cde7`. Note that this correlation ID is different from the one logged in the previous example.

== Example: Setting Correlation ID for a Database Query

The following example shows a scenario where you can modify the correlation ID while processing the results of a database query:

image::correlation-id-db.png[width=350]

----
   <flow name="correlation-id-flow">
		<db:select config-ref="Database_Config">
			<db:sql ><![CDATA[SELECT orderId, customerId, total from Orders  ]]></db:sql>
		</db:select>
		<foreach >
			<tracing:with-correlation-id correlationId="#[payload.orderId]">
				<logger level="INFO" message="#[correlationId]"/>
				<http:request method="GET" url="http://a-service.com" sendCorrelationId="ALWAYS"/>
			</tracing:with-correlation-id>
		</foreach>
	</flow>
----

In this case, each record obtained from the database is processed within the foreach scope, and the correlation ID for each iteration corresponds to the `orderId` of said record. In this scenario, if there is a problem during the HTTP request operation, the correlation ID enables you to track which record caused the error.
