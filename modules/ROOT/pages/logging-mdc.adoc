= MDC Logging
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: tracing, correlation, id, logging, mdc, variables, anypoint, studio

The MDC (_Mapped Diagnostic Context_) feature enriches logging to provide more context or information that is available in the current Mule event and also improve tracking.

By default, Mule logs two MDC entries: _processor_, which shows the current event location, and _event_, which shows the event correlation id.

With the Mule Tracing Module you can enhance your logs by adding, removing, and clearing variables from the logging context for a given Mule Event. The logging context exists for the entire execution of the corresponding event.

== Prerequisites

To use the MDC Logging operations, complete the following tasks:

* Install the Mule Tracing Module in your application.
* Change the pattern layouts in the `log4j.xml` file to MDC.

== Install the Mule Tracing Module

Follow the next steps to install the Mule Tracing Module in your application.

. Open your Mule project in Anypoint Studio.
. Go to the Mule Palette.
. Select **Search in Exchange**, and search for the Mule Tracing Module.
. Select the extension and click *Add*.
. Click *Finish*.

== Change the Pattern Layouts in the log4j.xml File

This change instructs Mule to automatically add the MDC context, which includes the correlation id and the processor path. You can modify the `log4j.xml` file of your Mule application or the file of your Mule instance, which is located in `/conf/log4j2.xml`.

Follow these steps to change the pattern layouts to MDC:

. Open the `log4j.xml` file for editing.
. Replace `[processor: %X{processorPath}; event: %X{correlationId}]` with `[%MDC]`.

=== Example log4j.xml File Configurations

.Example: Default log4j.xml file without MDC logging.
----
<PatternLayout pattern="%-5p %d [%t] [processor: %X{processorPath}; event: %X{correlationId}] %c: %m%n"/>
----

.Example: Updated log4j.xml file with MDC logging.
----
<PatternLayout pattern="%-5p %d [%t] [%MDC] %c: %m%n"/>
----

== Available Operations

// This will probably need to be set as a table as in other extensions
[%header%autowidth.spread,cols="a,a,a"]
|===
|XML Element | Description | Accepted Attributes
|`set-logging-variable` | Sets a logging variable and its value. |
[%header%autowidth.spreadcols="a,a"]
!===
! Attribute Name ! Description
!`variableName` ! The name of the variable to log.
! `value` ! The value to assign to the variable. Accepts DataWeave expressions.
!===
| `remove-logging-variable` | Removes a logging variable. |
[%header%autowidth.spreadcols="a,a"]
!===
! Attribute Name ! Description
! `variableName` ! The name of the variable to remove.
!===
| `clear-logging-variables` | Removes all the logging variables. This option does not remove the processor path nor the correlation ID
| None
|===

== Configure MDC Logging in Your Application

To configure MDC logging, add any of the available operations to your Mule application flow and specify the corresponding attributes.

For example, to configure a logging variable, insert the `<tracing:set-logging-variable>` XML element into your application flow:
----
<flow name="exmapleFlow">
    ...
    <tracing:set-logging-variable variableName="testVar" value="testValue" />
    ...
</flow>
----

After executing the flow, the output logs are:
----
INFO  2021-04-08 16:58:26,882 [[MuleRuntime].uber.15: [test-project-app].exmapleFlow.CPU_LITE @18f679] [{correlationId=c85e16c0-98a4-11eb-bc34-cac765a2219b, processorPath=exmapleFlow/processors/2, testVar=testValue}] org.mule.runtime.core.internal.processor.LoggerMessageProcessor: Example
----

This logging context affects any output of a Logger Message Processor and any internal logging that Mule runtime produces. Therefore, you can add more context to the event that Mule is processing in case you need additional information for tracking down any potential issue, for example, an unexpected error occurred.

== Example

Consider the following application:

image::mruntime-mdc-example.png[MDC Logging Example]

----
<flow name="logging-variables">
    <http:listener config-ref="HTTP_Listener_config" path="/order"/>
    <tracing:set-logging-variable variableName="customerId" value="#[payload.customerId]"/>
    <tracing:set-logging-variable variableName="requestPath" value='#["$(attributes.method):$(attributes.requestPath)"]'/>
    <logger level="INFO" message="#[output application/json --- payload]" />
</flow>
----

After sending the following request:

----
curl --location --request GET '0.0.0.0:8081/order' \
--header 'Content-Type: application/json' \
--data-raw '{
    "orderId": 548102842,
    "customerId": "ARG-12934",
    "items": [
        "CP-123",
        "CP-452"
    ]
}'
----

The output log is:

----
INFO  2021-04-09 11:14:38,409 [[MuleRuntime].uber.05: [tracing-module].tracing-moduleFlow.CPU_LITE @34a62707] [processor: tracing-moduleFlow/processors/2; event: eb2b2461-993d-11eb-8a64-4865ee1fd814] {correlationId=eb2b2461-993d-11eb-8a64-4865ee1fd814, customerId=ARG-12934, processorPath=tracing-moduleFlow/processors/2, requestPath=GET:/order} org.mule.runtime.core.internal.processor.LoggerMessageProcessor: {
    "orderId": 548102842,
    "customerId": "ARG-12934",
    "items": [
        "CP-123",
        "CP-452"
    ]
}
----

== See Also

* xref:logging-in-mule.adoc[Configuring Logging]
